<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="tm.comments.dao.ICommentsDao">

	<select id="selectOneByParent" resultType="CommentsVo" parameterType="String">
		SELECT b_idx, cm_depth+1 cm_depth, cm_order 
    	FROM comments
    	WHERE cm_idx=#{cm_idx}
	</select>
	
	<select id="selectOneMaxOrder" resultType="Integer" parameterType="String">
    	SELECT IFNULL(MAX(cm_order),0)+1
        FROM comments
        WHERE b_idx=#{b_idx}
    </select>
    
    <update id="updateByOrder" parameterType="CommentsVo"> 
    	UPDATE comments
        SET cm_order = cm_order + 1 
        WHERE b_idx=#{b_idx} AND cm_order>#{cm_order}       
    </update>
    
    <insert id="insertComments" parameterType="CommentsVo">
        <selectKey resultType="String" keyProperty="cm_idx" order="BEFORE">
            SELECT IFNULL(MAX(cm_idx),0)+1 FROM comments
        </selectKey>
    
        INSERT INTO comments(b_idx, cm_idx, cm_writer, cm_content, cm_order, cm_parent, cm_depth)
        VALUES (#{b_idx}, #{cm_idx}, #{cm_writer}, #{cm_content}, #{cm_depth},
                   <choose>
                       <when test="cm_parent==null">#{cm_idx}, 0</when>
                       <otherwise>#{cm_parent}, #{cm_depth}</otherwise>
                   </choose>
               )
    </insert>

	<insert id="commentsInsert" parameterType="CommentsVo">
		insert into comments
		values(
		0, #{b_idx}, #{userid}, #{cm_contents}, sysdate(),
		#{parent_code}, #{group_seq}, #{group_lv})
	</insert>

	<update id="commentsUpdate" parameterType="java.util.HashMap">
		update comments set
		cm_contents=#{cm_contents},
		cm_date=sysdate()
	</update>

	<delete id="commentsDelete" parameterType="int">
		delete from comments
		where cm_idx=#{cm_idx}
	</delete>

	<select id="commentsSelectByIdx" parameterType="int"
		resultType="java.util.HashMap">
		select *from tb_comments where b_idx=#{b_idx}
	</select>

	<!-- public int insertComments(HashMap<String, Object> params); -->
	<!-- public int updateComments(HashMap<String, Object> params); -->
	<!-- public int deleteComments(int b_idx, int c_idx); -->
	<!-- public List<HashMap<String, Object>> selectByIdx(int b_idx); -->


</mapper>